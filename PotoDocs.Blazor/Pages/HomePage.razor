@attribute [Authorize]
@page "/"
@inject NavigationManager Navigation
@inject IBlazorDownloadFileService BlazorDownloadFileService
@inject IOrderService OrderService
@inject IUserService UserService
@inject IToastService toastService
@inject IModalService Modal

<PageTitle>Ostatnie zlecenia</PageTitle>

<div class="header-section">
    <h1 class="header">Ostatnie zlecenia</h1>
    <div class="flex">
        <button class="refresh-button bi-icon-refresh" @onclick="RefreshOrders" disabled="@IsBusy">
        </button>
        <button class="btn-primary btn-small" @onclick="AddOrder">Dodaj zlecenie</button>
    </div>
</div>

<div class="container-flex-column">
    @if (IsBusy)
    {
        <div class="spinner-border text-danger" role="status">
            <span class="visually-hidden">Ładowanie...</span>
        </div>
    }
    else if (Orders == null || !Orders.Any())
    {
        <div class="empty-view">
            <p>Brak zleceń do wyświetlenia</p>
        </div>
    }
    else
    {
        @foreach (var order in Orders)
        {
            <div class="card-container container-flex" @onclick="() => ToggleOrder(order.InvoiceNumber)">
                <div class="order-details">
                    <h3 class="text-large">@order.Company.Name</h3>
                    <div class="container-flex-no-gap">
                        <p class="text-small">
                            @(order.Stops.Where(stop => stop.Type == StopType.Unloading)
                                .OrderByDescending(stop => stop.Date)
                                .FirstOrDefault()?.Date.ToString("dd.MM.yyyy") ?? "Brak daty")
                            • @(order.Price?.ToString("0.00") ?? "0") @order.Currency
                        </p>
                        <p class="text-small"><strong>@(order.Driver != null ? order.Driver.FirstAndLastName : "Brak kierowcy")</strong></p>
                    </div>
                </div>

                @if (ExpandedOrderId == order.InvoiceNumber)
                {
                    <div class="order-actions">
                        <button class="btn-secondary" @onclick="() => ViewOrderDetails(order)">
                            <span alt="Details" class="bi-icon-add-order" />Szczegóły
                        </button>
                        <button class="btn-secondary" @onclick="() => EditOrder(order)">
                            <span alt="Edit" class="bi-icon-edit" />Edytuj
                            </button>
                        <button class="btn-secondary" @onclick="() => DownloadInvoice(order)">
                            <span alt="Download" class="bi-icon-download" />Faktura
                        </button>
                        <button class="btn-secondary btn-delete" @onclick="() => DeleteOrder(order)">
                            <span alt="Delete" class="bi-icon-delete" />Usuń
                        </button>
                    </div>
                }
            </div>
        }
    }
</div>

<div class="btn-section">
    <button class="btn-primary" @onclick="ShowMoreOrders">Pokaż więcej</button>
</div>

@code {
    private IEnumerable<OrderDto> Orders;
    private bool IsBusy = false;
    private UserDto User;
    private int? ExpandedOrderId = null;

    private void ToggleOrder(int orderId)
    {
        ExpandedOrderId = ExpandedOrderId == orderId ? null : orderId;
    }

    protected override async Task OnInitializedAsync()
    {
        await GetUser();
        await RefreshOrders();
    }

    private async Task GetUser()
    {
        try
        {
            IsBusy = true;
            User = await UserService.GetCurrentUser();
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Błąd: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task RefreshOrders()
    {
        try
        {
            IsBusy = true;
            Orders = await OrderService.GetAll(1, 5, User.Email);
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Błąd: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void AddOrder()
    {
        Navigation.NavigateTo("/zlecenie/edycja");
    }

    private void EditOrder(OrderDto order)
    {
        if (order != null)
        {
            var orderJson = Uri.EscapeDataString(JsonSerializer.Serialize(order));
            Navigation.NavigateTo($"/zlecenie/edycja?order={orderJson}");
        }
    }

    private void ViewOrderDetails(OrderDto order)
    {
        if (order != null)
        {
            var orderJson = Uri.EscapeDataString(JsonSerializer.Serialize(order));
            Navigation.NavigateTo($"/zlecenie/szczegoly?order={orderJson}");
        }
    }
     
    private async Task DownloadInvoice(OrderDto order)
    {
        if (order == null) return;

        try
        {
            IsBusy = true;
            string name = $"FAKTURA {order.InvoiceNumber}-{order.IssueDate:MM-yyyy}";
            var fileBytes = await OrderService.DownloadInvoice(order.Id);

            await BlazorDownloadFileService.DownloadFile(name, fileBytes, "application/pdf");

            toastService.ShowSuccess($"Pobrano {name}");
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Błąd podczas pobierania faktury: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }


    private async Task DeleteOrder(OrderDto order)
    {
        if (order == null) return;

        var parameters = new ModalParameters();
        string name = $"FAKTURA {order.InvoiceNumber}-{order.IssueDate:MM-yyyy}";

        parameters.Add("Message", $"Czy na pewno chcesz usunąć zlecenie {name}?");
        

        var modalRef = Modal.Show<ConfirmDialog>("Potwierdzenie", parameters);
        var result = await modalRef.Result;

        if (!result.Cancelled)
        {
            try
            {
                IsBusy = true;
                await OrderService.Delete(order.Id);
                await RefreshOrders();
                toastService.ShowSuccess($"Pomyślnie usunięto zlecenie {name}");
            }
            catch (Exception ex)
            {
                toastService.ShowError($"Błąd podczas usuwania zlecenia: {ex.Message}");
            }
            finally
            {
                IsBusy = false;
            }
        }
    }
    private async Task ShowMoreOrders()
    {
        try
        {
            IsBusy = true;

            var ordersList = Orders.ToList();

            if (ordersList.Count % 5 == 0)
            {
                int currentPage = ordersList.Count / 5 + 1;
                var newOrders = await OrderService.GetAll(currentPage, 5, User.Email);

                if (newOrders?.Any() == true)
                {
                    ordersList.AddRange(newOrders);
                    Orders = ordersList;
                }
            }
            else
            {
                toastService.ShowInfo($"Brak zleceń do pobrania.");
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Błąd: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }
}
