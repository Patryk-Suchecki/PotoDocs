@attribute [Authorize]
@page "/zlecenia"

<MudBreadcrumbs Items="_items"></MudBreadcrumbs>
<PageTitle>Zlecenia</PageTitle>
<MudText Typo="Typo.h4" GutterBottom="true" Color="Color.Primary">Zlecenia</MudText>

<MudTable Items="@orders" Filter="new Func<OrderDto, bool>(FilterFunc1)" GroupBy="@_groupDefinition" Loading="@IsLoading" LoadingProgressColor="Color.Primary" MultiSelection="true" @bind-SelectedItems="selectedOrders">
    <ToolBarContent>
        <MudTextField @bind-Value="searchString" Placeholder="Szukaj" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="Create" Class="mr-2" />
        <MudMenu Icon="@Icons.Material.Filled.MoreVert">
            <MudMenuItem Label="Zarejestruj wysyłkę pocztą" Icon="@Icons.Material.Filled.MarkEmailRead" @onclick="() => OpenMarkSentDialogAsync()" />
            <MudMenuItem Label="Pobierz pliki zleceń" Icon="@Icons.Material.Filled.PictureAsPdf" @onclick="() => DownloadOrders()" />
            <MudMenuItem Label="Pobierz komplet dokumentów" Icon="@Icons.Material.Filled.FolderZip" @onclick="() => DownloadDocuments()" />
        </MudMenu>
    </ToolBarContent>

    <HeaderContent>
        <MudTh>Zleceniodawca</MudTh>
        <MudTh>Kierowca</MudTh>
        <MudTh>Rozładunek</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Kwota</MudTh>
        <MudTh></MudTh>
    </HeaderContent>

    <GroupHeaderTemplate>
        <MudTh Class="mud-table-cell-custom-group" colspan="6">@($"{context.Key}") </MudTh>
    </GroupHeaderTemplate>
    <RowTemplate>
        <MudTd DataLabel="Zleceniodawca">@context.Company.Name</MudTd>
        <MudTd DataLabel="Kierowca">@(context.Driver?.FirstAndLastName ?? "Brak kierowcy")</MudTd>
        <MudTd DataLabel="Rozładunek">@((context.Stops.Where(stop => stop.Type == StopType.Unloading).OrderByDescending(stop => stop.Date).FirstOrDefault()?.Date)?.ToString("dd.MM.yyyy") ?? "Brak daty")</MudTd>
        <MudTd DataLabel="Status">@(context.Files.Where(o => o.Type == FileType.Cmr).Count() > 0 ? "Nie zapłacono" : "Brak CMR")</MudTd>
        <MudTd DataLabel="Cena">@FormatMoney(context.Price, context.Currency)</MudTd>
        <MudTd DataLabel="Akcje" Style="text-align:right">
            <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                @if (!context.HasInvoice)
                {
                    <MudMenuItem Label="Wystaw fakturę" Icon="@Icons.Material.Filled.Download" @onclick="() => CreateInvoice(context)" />
                }
                @if (context.Company != null && context.Company.AcceptsEInvoices)
                {
                    <MudMenuItem Label="Wyślij e-mail" Icon="@Icons.Material.Filled.Email" @onclick="() => SendEmail(context)" />
                }
                <MudMenuItem Label="Szczegóły" Icon="@Icons.Material.Filled.Visibility" @onclick="() => Details(context)" />
                <MudMenuItem Label="Edytuj" Icon="@Icons.Material.Filled.Edit" @onclick="() => Edit(context)" />
                <MudMenuItem Label="Usuń" Icon="@Icons.Material.Filled.Delete" @onclick="() => Delete(context)" />
            </MudMenu>
        </MudTd>
    </RowTemplate>
</MudTable>