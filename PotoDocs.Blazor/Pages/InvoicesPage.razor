@attribute [Authorize]
@page "/faktury"

<MudBreadcrumbs Items="_items"></MudBreadcrumbs>
<PageTitle>Faktury</PageTitle>
<MudText Typo="Typo.h4" GutterBottom="true" Color="Color.Primary">Faktury</MudText>

<MudTable T="InvoiceDto" Items="@invoices" Filter="new Func<InvoiceDto, bool>(FilterFunc1)" GroupBy="@_sorter.GroupDefinition" Loading="@IsLoading" LoadingProgressColor="Color.Primary" MultiSelection="true" @bind-SelectedItems="selectedInvoices" Striped="true" Hover="true">
    <ToolBarContent>
        <MudTextField @bind-Value="searchString" Placeholder="Szukaj" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="Create" Class="mr-2" />
        <MudMenu Icon="@Icons.Material.Filled.MoreVert">
            <MudMenuItem Label="Pobierz paczkę" Icon="@Icons.Material.Filled.FolderZip" @onclick="() => DownloadInvoices()" />
        </MudMenu>
    </ToolBarContent>

    <HeaderContent>
        <MudTh>
            <MudTableSortLabel SortBy="@_sorter.Sort(x => x.InvoiceNumber)"
                               InitialDirection="SortDirection.Descending"
                               SortDirectionChanged="OnSortDirectionChanged"
                               T="InvoiceDto">
                Nr
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="@_sorter.Sort(x => x.BuyerName)"
                               SortDirectionChanged="OnSortDirectionChanged"
                               T="InvoiceDto">
                Nabywca
            </MudTableSortLabel>
        </MudTh>

        <MudTh>
            <MudTableSortLabel SortBy="@_sorter.Sort(x => x.IssueDate)"
                               SortDirectionChanged="OnSortDirectionChanged"
                               T="InvoiceDto">
                Data wystawienia
            </MudTableSortLabel>
        </MudTh>

        <MudTh>Płatność</MudTh>

        <MudTh></MudTh>
    </HeaderContent>
    <GroupHeaderTemplate>
        <MudTh colspan="6">
            @{
                var dateKey = context.Key as DateTime?;
            }
            @if (dateKey.HasValue && dateKey.Value != DateTime.MinValue)
            {
                <b>@System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(dateKey.Value.ToString("MMMM yyyy", new System.Globalization.CultureInfo("pl-PL")))</b>
            }
            else
            {
                <b>Brak daty rozładunku</b>
            }
        </MudTh>
    </GroupHeaderTemplate>

    <RowTemplate>
        <MudTd DataLabel="Nr">@context.Name</MudTd>
        <MudTd DataLabel="Nabywca">@context.BuyerName</MudTd>
        <MudTd DataLabel="Data wystawienia">@context.IssueDate?.ToString("dd.MM.yyyy")</MudTd>
        <MudTd DataLabel="Płatność">
            <MudChip T="string" Color="@context.GetStatusColor()" Size="Size.Small" Variant="Variant.Text">@context.GetStatusText()</MudChip>
            </MudTd>
        <MudTd DataLabel="Akcje" Style="text-align:right">
            @{
                var strategy = InvoiceStrategyFactory.GetStrategy(context.Type);
            }
            <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                <MudMenuItem Label="Pobierz" Icon="@Icons.Material.Filled.Download" @onclick="async () => await strategy.DownloadAsync(context)" />
                <MudMenuItem Label="Szczegóły" Icon="@Icons.Material.Filled.Visibility" @onclick="async () => await strategy.DetailsAsync(context)" />

                @if (strategy.CanEdit(context))
                {
                    <MudMenuItem Label="Edytuj" Icon="@Icons.Material.Filled.Edit" @onclick="async () => await HandleAction(() => strategy.EditAsync(context))" />
                    <MudMenuItem Label="Usuń" Icon="@Icons.Material.Filled.Delete" @onclick="async () => await HandleAction(() => strategy.DeleteAsync(context))" />
                }

                @if (strategy.CanCorrect(context))
                {
                    <MudMenuItem Label="Koryguj" Icon="@Icons.Material.Filled.PostAdd" @onclick="async () => await HandleAction(() => strategy.CorrectAsync(context))" />
                }
                <MudMenuItem Label="Pokaż zlecenie" Icon="@Icons.Material.Filled.Assignment" OnClick="@(() => GoToOrder(context.Name))" />

            </MudMenu>
        </MudTd>
    </RowTemplate>
</MudTable>