@attribute [Authorize]
@page "/kierowcy"
@inject IUserService UserService
@inject NavigationManager Navigation
@inject IToastService toastService

<h3 class="header">Kierowcy</h3>

@if (IsBusy)
{
    <div class="spinner-border text-danger" role="status">
        <span class="visually-hidden">Ładowanie...</span>
    </div>
}
else if (Users?.Count > 0)
{
    <div class="container-flex-column margin-top-15">
        @foreach (var user in Users)
        {
            <div class="card-container margin-bottom--15" @onclick="() => GoToEditUser(user)">
                <div class="container-flex-no-gap">
                <label class="text-small"><img src="images/icon_user.png" class="icon-img" />@user.FirstName @user.LastName</label>
                <button @onclick="() => DeleteUser(user)" class="btn-primary btn-small btn-delete">
                    <img src="images/icon_delete.png" class="btn-img" />Usuń
                </button>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="empty-state">
        <p>Brak kierowców do wyświetlenia.</p>
    </div>
}
<div class="btn-section">
    <button class="btn-primary" @onclick="GoToNewUser" disabled="@IsBusy">Dodaj kierowcę</button>
</div>

@code {
    private bool IsBusy { get; set; } = false;
    private List<UserDto> Users { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await GetUsersAsync();
    }

    private async Task GetUsersAsync()
    {
        try
        {
            IsBusy = true;
            Users = (await UserService.GetAll()).ToList();
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Błąd podczas pobierania użytkowników: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void GoToNewUser()
    {
        Navigation.NavigateTo("/kierowca?title=Dodaj kierowcę");
    }

    private void GoToEditUser(UserDto user)
    {
        if (user != null)
        {
            var userJson = Uri.EscapeDataString(JsonSerializer.Serialize(user));
            Navigation.NavigateTo($"/kierowca?user={userJson}");
        }
    }
    private async Task DeleteUser(UserDto user)
    {
        try
        {
            IsBusy = true;
            await UserService.Delete(user.Email);
            toastService.ShowSuccess("Pomyślnie usunięto użytkownika");
            await GetUsersAsync();

        }
        catch (Exception ex)
        {
            toastService.ShowError($"Błąd przy usuwaniu użytkownika: {ex.Message}");
        }
        finally
        {
            IsBusy = false;
        }
    }
}
