<MudDialog>
    <DialogContent>
        <MudForm @ref="form" Model="@InvoiceDto" Validation="@(invoiceValidator.ValidateValue)" ValidationDelay="0">
            <MudText Typo="Typo.h6" Class="mt-4">Faktura</MudText>
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="4">
                    <MudNumericField @bind-Value="InvoiceDto.InvoiceNumber" Label="Numer faktury" Variant="Variant.Outlined" Min="0" Disabled="@IsDisabled" For="@(() => InvoiceDto.InvoiceNumber)" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="Data wystawienia" Editable="true" @bind-Date="InvoiceDto.IssueDate" Mask="@(new DateMask("00-00-0000"))" DateFormat="dd-MM-yyyy" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceDto.IssueDate)" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="Data sprzedaży" Editable="true" @bind-Date="InvoiceDto.SaleDate" Mask="@(new DateMask("00-00-0000"))" DateFormat="dd-MM-yyyy" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceDto.SaleDate)" />
                </MudItem>
            </MudGrid>
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6">
                    <MudDatePicker Label="Data wysłania" Editable="true" @bind-Date="InvoiceDto.SentDate" Mask="@(new DateMask("00-00-0000"))" DateFormat="dd-MM-yyyy" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceDto.SentDate)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="DeliveryMethodType?" @bind-Value="InvoiceDto.DeliveryMethod" Label="Metoda dostarczenia" Variant="Variant.Outlined" Disabled="@IsDisabled" Clearable="true" For="@(() => InvoiceDto.DeliveryMethod)">
                        <MudSelectItem Value="@((DeliveryMethodType?)DeliveryMethodType.Email)">Email</MudSelectItem>
                        <MudSelectItem Value="@((DeliveryMethodType?)DeliveryMethodType.Post)">Poczta tradycyjna</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
            <MudText Typo="Typo.h6" Class="mt-4">Nabywca</MudText>
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="4">
                    <MudTextField @bind-Value="InvoiceDto.BuyerNIP" Label="NIP" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceDto.BuyerNIP)" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField @bind-Value="InvoiceDto.BuyerName" Label="Nazwa" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceDto.BuyerName)" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudTextField @bind-Value="InvoiceDto.BuyerAddress" Label="Adres" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceDto.BuyerAddress)" />
                </MudItem>
            </MudGrid>

            <MudText Typo="Typo.h6" Class="mt-4">Warunki Płatności</MudText>
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="4">
                    <MudTextField @bind-Value="InvoiceDto.PaymentMethod" Label="Metoda płatności" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceDto.PaymentMethod)" />
                </MudItem>
                <MudItem xs="12" sm="3">
                    <MudNumericField @bind-Value="InvoiceDto.PaymentDeadlineDays" Label="Dni do płatności" Variant="Variant.Outlined" Min="0" Disabled="@IsDisabled" For="@(() => InvoiceDto.PaymentDeadlineDays)" />
                </MudItem>
                <MudItem xs="12" sm="3">
                    <MudSelect T="CurrencyType" @bind-Value="InvoiceDto.Currency" Label="Waluta" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceDto.Currency)">
                        @foreach (var currency in Enum.GetValues<CurrencyType>())
                        {
                            <MudSelectItem Value="@currency">@currency.ToString()</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="2">
                    <MudCheckBox T="bool" @bind-Value="InvoiceDto.HasPaid" Label="Zapłacono" Color="Color.Primary" Disabled="@(IsDisabled)" For="@(() => InvoiceDto.HasPaid)" />
                
                </MudItem>
            </MudGrid>

            <MudTable Items="@InvoiceDto.Items"
                      RowEditCommit="OnItemCommit"
                      RowEditPreview="BackupItem" RowEditCancel="ResetItemToOriginalValues"
                      ApplyButtonPosition="TableApplyButtonPosition.End" EditButtonPosition="TableEditButtonPosition.End" EditTrigger="TableEditTrigger.RowClick">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Pozycje</MudText>
                    @if (!IsDisabled)
                    {
                        <MudSpacer />
                        <MudFab StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" Style="background-color: white; color: black;" OnClick="AddNewItem" />
                    }
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Nazwa</MudTh>
                    <MudTh>Ilość</MudTh>
                    <MudTh>JM</MudTh>
                    <MudTh>Cena netto</MudTh>
                    <MudTh>VAT</MudTh>
                    <MudTh>Wartość brutto</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Nazwa">@context.Name</MudTd>
                    <MudTd DataLabel="Ilość">@context.Quantity</MudTd>
                    <MudTd DataLabel="JM">@context.Unit</MudTd>
                    <MudTd DataLabel="Cena netto">@context.NetPrice.ToString("C2")</MudTd>
                    <MudTd DataLabel="VAT">@context.VatRate.ToString("P0")</MudTd>
                    <MudTd DataLabel="Wartość brutto">@context.GrossValue.ToString("C2")</MudTd>
                </RowTemplate>
                <RowEditingTemplate>
                    <MudTd DataLabel="Nazwa">
                        <MudTextField @bind-Value="context.Name" Required Label="Nazwa pozycji" />
                    </MudTd>

                    <MudTd DataLabel="Ilość">
                        <MudNumericField @bind-Value="context.Quantity" Required Min="0" Label="Ilość" />
                    </MudTd>

                    <MudTd DataLabel="JM">
                        <MudTextField @bind-Value="context.Unit" Required Label="Jednostka" />
                    </MudTd>

                    <MudTd DataLabel="Cena netto">
                        <MudNumericField @bind-Value="context.NetPrice" Required Min="0" Format="F2" Label="Cena netto" />
                    </MudTd>

                    <MudTd DataLabel="VAT">
                        <MudNumericField @bind-Value="context.VatRate" Required Min="0" Format="F2" Label="Stawka"/>
                    </MudTd>
                </RowEditingTemplate>
                <EditButtonContent Context="button">
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" Disabled="@button.ButtonDisabled" />
                </EditButtonContent>
            </MudTable>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="MudDialog.Cancel">Anuluj</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SubmitAsync">@ButtonLabel</MudButton>
    </DialogActions>
</MudDialog>