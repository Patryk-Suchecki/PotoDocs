<MudDialog>
    <DialogContent>
        <MudForm @ref="form" Model="@InvoiceCorrectionDto" Validation="@(invoiceCorrectionValidator.ValidateValue)" ValidationDelay="0">
            <MudGrid Spacing="2">
                @if (Type != InvoiceCorrectionFormType.Create)
                {
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="InvoiceCorrectionDto.InvoiceNumber" Label="Numer faktury" Variant="Variant.Outlined" Min="0" Disabled="@IsDisabled" For="@(() => InvoiceCorrectionDto.InvoiceNumber)" />
                    </MudItem>
                }

                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="Data wystawienia" Editable="true" @bind-Date="InvoiceCorrectionDto.IssueDate" Mask="@(new DateMask("00-00-0000"))" DateFormat="dd-MM-yyyy" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceCorrectionDto.IssueDate)" />
                </MudItem>
            </MudGrid>
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="5">
                    <MudDatePicker Label="Data wysłania" Editable="true" @bind-Date="InvoiceCorrectionDto.SentDate" Mask="@(new DateMask("00-00-0000"))" DateFormat="dd-MM-yyyy" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceCorrectionDto.SentDate)" />
                </MudItem>
                <MudItem xs="12" sm="5">
                    <MudSelect T="DeliveryMethodType?" @bind-Value="InvoiceCorrectionDto.DeliveryMethod" Label="Metoda dostarczenia" Variant="Variant.Outlined" Disabled="@IsDisabled" Clearable="true" For="@(() => InvoiceCorrectionDto.DeliveryMethod)">
                        <MudSelectItem Value="@((DeliveryMethodType?)DeliveryMethodType.Email)">Email</MudSelectItem>
                        <MudSelectItem Value="@((DeliveryMethodType?)DeliveryMethodType.Post)">Poczta tradycyjna</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="2">
                    <MudCheckBox T="bool" @bind-Value="InvoiceCorrectionDto.HasPaid" Label="Zapłacono" Color="Color.Primary" Disabled="@(IsDisabled)" For="@(() => InvoiceCorrectionDto.HasPaid)" />
                </MudItem>
            </MudGrid>

            <MudTextField @bind-Value="InvoiceCorrectionDto.Comments" Label="Przyczyny korekty" Variant="Variant.Outlined" Disabled="@IsDisabled" For="@(() => InvoiceCorrectionDto.Comments)" />

            <MudTable Items="@InvoiceCorrectionDto.OriginalInvoice.Items" Class="my-4">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Pozycje było:</MudText>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Nazwa</MudTh>
                    <MudTh>Ilość</MudTh>
                    <MudTh>JM</MudTh>
                    <MudTh>Cena netto</MudTh>
                    <MudTh>VAT</MudTh>
                    <MudTh>Wartość brutto</MudTh>
                    <MudTh Style="width: 50px;"></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Nazwa">@context.Name</MudTd>
                    <MudTd DataLabel="Ilość">@context.Quantity</MudTd>
                    <MudTd DataLabel="JM">@context.Unit</MudTd>
                    <MudTd DataLabel="Cena netto">@context.NetPrice.FormatMoney(InvoiceCorrectionDto.OriginalInvoice.Currency)</MudTd>
                    <MudTd DataLabel="VAT">@context.VatRate.ToString("P0")</MudTd>
                    <MudTd DataLabel="Wartość brutto">@context.GrossValue.FormatMoney(InvoiceCorrectionDto.OriginalInvoice.Currency)</MudTd>
                    <MudTd>
                        @if (!IsDisabled)
                        {
                                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               OnClick="@(() => CopyItemToCorrection(context))" />
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <MudTable Items="@InvoiceCorrectionDto.Items"
                      RowEditCommit="OnItemCommit"
                      RowEditPreview="BackupItem" RowEditCancel="ResetItemToOriginalValues"
                      ApplyButtonPosition="TableApplyButtonPosition.End" EditButtonPosition="TableEditButtonPosition.End" EditTrigger="TableEditTrigger.RowClick">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Pozycje powinno być:</MudText>
                    @if (!IsDisabled)
                    {
                        <MudSpacer />
                        <MudFab StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" Style="background-color: white; color: black;" OnClick="AddNewItem" />
                    }
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Nazwa</MudTh>
                    <MudTh>Ilość</MudTh>
                    <MudTh>JM</MudTh>
                    <MudTh>Cena netto</MudTh>
                    <MudTh>VAT</MudTh>
                    <MudTh>Wartość brutto</MudTh>
                    <MudTh Style="width: 50px;"></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Nazwa">@context.Name</MudTd>
                    <MudTd DataLabel="Ilość">@context.Quantity</MudTd>
                    <MudTd DataLabel="JM">@context.Unit</MudTd>
                    <MudTd DataLabel="Cena netto">@context.NetPrice.FormatMoney(InvoiceCorrectionDto.OriginalInvoice.Currency)</MudTd>
                    <MudTd DataLabel="VAT">@context.VatRate.ToString("P0")</MudTd>
                    <MudTd DataLabel="Wartość brutto">@context.GrossValue.FormatMoney(InvoiceCorrectionDto.OriginalInvoice.Currency)</MudTd>
                    <MudTd>
                        @if (!IsDisabled)
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => RemoveItem(context))" />
                        }
                    </MudTd>
                </RowTemplate>
                <RowEditingTemplate>
                    <MudTd DataLabel="Nazwa">
                        <MudTextField @bind-Value="context.Name" Required Label="Nazwa pozycji" />
                    </MudTd>

                    <MudTd DataLabel="Ilość">
                        <MudNumericField @bind-Value="context.Quantity" Required Min="0" Label="Ilość" />
                    </MudTd>

                    <MudTd DataLabel="JM">
                        <MudTextField @bind-Value="context.Unit" Required Label="Jednostka" />
                    </MudTd>

                    <MudTd DataLabel="Cena netto">
                        <MudNumericField @bind-Value="context.NetPrice" Required Min="0" Format="F2" Label="Cena netto" />
                    </MudTd>

                    <MudTd DataLabel="VAT">
                        <MudNumericField @bind-Value="context.VatRate" Required Min="0" Format="F2" Label="Stawka"/>
                    </MudTd>
                </RowEditingTemplate>
                <EditButtonContent Context="button">
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" Disabled="@button.ButtonDisabled" />
                </EditButtonContent>
            </MudTable>

        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="MudDialog.Cancel">Anuluj</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SubmitAsync">@ButtonLabel</MudButton>
    </DialogActions>
</MudDialog>