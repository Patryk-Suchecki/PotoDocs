<MudDrawer Open="IsOpen" OpenChanged="OnOpenChanged" Anchor="Anchor.End" Elevation="2" Variant="DrawerVariant.Temporary" Width="min(100vw, 500px)">
    <MudDrawerHeader Class="d-flex align-center justify-space-between pt-4 pb-2">
        <MudText Typo="Typo.h6">Szczegóły zlecenia</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="CloseDrawer" Size="Size.Small" />
    </MudDrawerHeader>

    @if (Order != null)
    {
        <MudContainer Class="pa-5" Style="overflow-y: auto;">

            <MudStack Spacing="1" Class="mb-6">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Numer zlecenia</MudText>
                <MudText Typo="Typo.h5"><b>@(string.IsNullOrWhiteSpace(Order.OrderNumber) ? "Brak numeru" : Order.OrderNumber)</b></MudText>
            </MudStack>

            <MudText Typo="Typo.subtitle2" Class="mb-2 pl-1">Zleceniodawca</MudText>
            <MudPaper Elevation="0" Outlined="true" Class="pa-4 mb-6">
                <MudStack Spacing="3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                        <MudIcon Icon="@Icons.Material.Outlined.Business" Color="Color.Surface" Style="color: var(--mud-palette-text-secondary);" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Firma</MudText>
                            <MudText Typo="Typo.body2"><b>@Order.Company?.Name</b></MudText>
                            <MudText Typo="Typo.caption">NIP: @Order.Company?.NIP</MudText>
                        </MudStack>
                    </MudStack>

                    <MudDivider />

                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                        <MudIcon Icon="@Icons.Material.Outlined.LocationOn" Color="Color.Surface" Style="color: var(--mud-palette-text-secondary);" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Adres</MudText>
                            <MudText Typo="Typo.body2">@Order.Company?.Address</MudText>
                            @if (!string.IsNullOrWhiteSpace(Order.Company?.CorrespondenceAddress))
                            {
                                <MudText Typo="Typo.caption">Koresp: @Order.Company.CorrespondenceAddress</MudText>
                            }
                        </MudStack>
                    </MudStack>

                    <MudDivider />

                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                        <MudIcon Icon="@Icons.Material.Outlined.Email" Color="Color.Surface" Style="color: var(--mud-palette-text-secondary);" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Kontakt</MudText>
                            <MudLink Href="@($"mailto:{Order.Company?.EmailAddress}")" Underline="Underline.Hover" Typo="Typo.body2">@Order.Company?.EmailAddress</MudLink>
                            @if (Order.Company?.AcceptsEInvoices == true)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Success">Akceptuje E-faktury</MudText>
                            }
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>

            <MudText Typo="Typo.subtitle2" Class="mb-2 pl-1">Informacje o transporcie</MudText>
            <MudPaper Elevation="0" Outlined="true" Class="pa-4 mb-6">
                <MudGrid Spacing="2">
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Data rozładunku</MudText>
                        <MudText Typo="Typo.body2">@(Order.UnloadingDate?.ToString("dd-MM-yyyy") ?? "Brak")</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Kwota</MudText>
                        <MudText Typo="Typo.body2"><b>@Order.Price.ToString("F2") @Order.Currency</b></MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Termin płatności</MudText>
                        <MudText Typo="Typo.body2">@Order.PaymentDeadline dni</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Kierowca</MudText>
                        <MudText Typo="Typo.body2">@(Order.Driver?.FirstAndLastName ?? "Nie przypisano")</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudText Typo="Typo.subtitle2" Class="mb-2 pl-1">Przystanki</MudText>
            <MudPaper Elevation="0" Outlined="true" Class="overflow-hidden mb-6">
                @if (Order.Stops != null && Order.Stops.Any())
                {
                    <MudList T="OrderStopDto" Dense="true">
                        @foreach (var stop in Order.Stops.OrderBy(s => s.Date))
                        {
                            <MudListItem Icon="@(stop.Type == StopType.Loading ? Icons.Material.Outlined.FileUpload : Icons.Material.Outlined.FileDownload)">
                                <MudStack Spacing="0">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.body2"><b>@(stop.Type == StopType.Loading ? "Załadunek" : "Rozładunek")</b></MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@(stop.Date?.ToString("dd-MM-yyyy HH:mm"))</MudText>
                                    </MudStack>
                                    <MudText Typo="Typo.body2">@stop.Address</MudText>
                                </MudStack>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="pa-4 text-center" Color="Color.Secondary">Brak zdefiniowanych przystanków.</MudText>
                }
            </MudPaper>

            <MudText Typo="Typo.subtitle2" Class="mb-2 pl-1">Załączone pliki</MudText>
            <MudPaper Elevation="0" Outlined="true" Class="overflow-hidden">
                @if (Order.Files != null && Order.Files.Any())
                {
                    <MudList T="OrderFileDto" Dense="true">
                        @foreach (var file in Order.Files)
                        {
                            <MudListItem Icon="@Icons.Material.Outlined.PictureAsPdf">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body2">@file.Name</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @(file.Type == FileType.Order ? "Zlecenie" : "CMR") • @((file.Size / (1024.0 * 1024.0)).ToString("F2")) MB
                                        </MudText>
                                    </MudStack>
                                    <MudIconButton Icon="@Icons.Material.Filled.Download" Size="Size.Small" Color="Color.Primary" OnClick="() => OnDownloadFile.InvokeAsync(file)" />
                                </MudStack>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="pa-4 text-center" Color="Color.Secondary">Brak załączonych plików.</MudText>
                }
            </MudPaper>

        </MudContainer>
    }
</MudDrawer>

@code {
    [Parameter]
    public OrderDto Order { get; set; }

    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public EventCallback<OrderFileDto> OnDownloadFile { get; set; }

    private async Task CloseDrawer()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

    private async Task OnOpenChanged(bool newValue)
    {
        IsOpen = newValue;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }
}